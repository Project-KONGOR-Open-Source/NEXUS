@page "/profile"
@using global::DAWNBRINGER.WebPortal.UI.Services
@using System.Net.Http.Headers
@inject HttpClient Http
@inject AuthService BuildAuth
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>My Profile</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            @if (IsLoading)
            {
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (User != null)
            {
                <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
                    <div class="card-header bg-primary text-white text-center py-5" style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);">
                        @if (!string.IsNullOrEmpty(User.ProfilePictureUrl))
                        {
                            <img src="@User.ProfilePictureUrl" alt="Avatar" class="rounded-circle border border-4 border-white shadow mb-3" style="width: 150px; height: 150px; object-fit: cover;" />
                        }
                        <h2 class="mb-0 fw-bold display-6">@User.Accounts.FirstOrDefault()?.Name</h2>
                    </div>
                    <div class="card-body p-5 bg-light">
                        
                        <div class="row g-4 mb-5">
                            <div class="col-12">
                                <h4 class="text-muted text-uppercase fw-bold text-center mb-4">Wallet</h4>
                            </div>
                            <div class="col-md-6">
                                <div class="p-4 bg-white rounded-3 shadow-sm border text-center h-100 d-flex flex-column justify-content-center">
                                    <i class="bi bi-coin text-warning display-4 d-block mb-2"></i>
                                    <span class="d-block text-muted text-uppercase small fw-bold">Gold</span>
                                    <span class="fw-bold display-6 text-dark">@User.GoldCoins</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-4 bg-white rounded-3 shadow-sm border text-center h-100 d-flex flex-column justify-content-center">
                                    <i class="bi bi-currency-exchange text-secondary display-4 d-block mb-2"></i>
                                    <span class="d-block text-muted text-uppercase small fw-bold">Silver</span>
                                    <span class="fw-bold display-6 text-dark">@User.SilverCoins</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                             <h4 class="text-muted text-uppercase fw-bold text-center mb-4">Stats</h4>
                            <div class="list-group shadow-sm rounded-3">
                                <div class="list-group-item p-4 d-flex justify-content-between align-items-center">
                                    <span class="fs-5"><i class="bi bi-star-fill text-primary me-3"></i> Total Level</span>
                                    <span class="badge bg-primary rounded-pill fs-5 px-3 py-2">@User.TotalLevel</span>
                                </div>
                                <div class="list-group-item p-4 d-flex justify-content-between align-items-center">
                                    <span class="fs-5"><i class="bi bi-ticket-perforated-fill text-danger me-3"></i> Plinko Tickets</span>
                                    <span class="badge bg-danger rounded-pill fs-5 px-3 py-2">@User.PlinkoTickets</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-center gap-4 align-items-center">
                            <button class="btn btn-outline-danger btn-lg px-5 py-3 fw-bold rounded-pill" @onclick="SignOut">
                                <i class="bi bi-box-arrow-right me-2"></i> Sign Out
                            </button>
                            <a href="/" class="btn btn-link text-muted text-decoration-none">Back to Home</a>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center alert alert-warning p-5 shadow-sm rounded-3">
                    <h3 class="text-muted mb-4">You are not logged in.</h3>
                    <a href="login" class="btn btn-primary btn-lg px-5 rounded-pill">Log In</a>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private global::DAWNBRINGER.WebPortal.UI.DTOs.GetBasicUserDTO? User;
    private bool IsLoading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProfile();
            StateHasChanged(); // Trigger re-render after async load
        }
    }

    private async Task LoadProfile()
    {
        try
        {
            var session = await BuildAuth.LoadSessionAsync();
            if (string.IsNullOrEmpty(session.Token) || session.UserId == null)
            {
                IsLoading = false;
                return;
            }

            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", session.Token);
            User = await Http.GetFromJsonAsync<global::DAWNBRINGER.WebPortal.UI.DTOs.GetBasicUserDTO>($"User/{session.UserId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SignOut()
    {
        await BuildAuth.ClearSessionAsync();
        Navigation.NavigateTo("/", forceLoad: true);
    }
}
