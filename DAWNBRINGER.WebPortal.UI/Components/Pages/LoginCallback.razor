@page "/login-callback"
@using global::DAWNBRINGER.WebPortal.UI.Services
@inject NavigationManager Navigation
@inject AuthService BuildAuth
@inject ILogger<LoginCallback> logger
@rendermode InteractiveServer

<PageTitle>Login Processing</PageTitle>

<div class="d-flex justify-content-center align-items-center mt-5">
    <div class="text-center">
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger">
                <strong>Error:</strong> @ErrorMessage
            </div>
            <a href="/" class="btn btn-primary mt-3">Go Home</a>
        }
        else
        {
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Logging in...</span>
            </div>
            <p class="mt-3 text-muted">Authenticating...</p>
        }
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    [SupplyParameterFromQuery(Name = "userid")]
    public int? UserID { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine($"[LoginCallback] OnAfterRenderAsync called. Token: {Token?.Substring(0, 10)}..., UserID: {UserID}");
            try
            {
                if (!string.IsNullOrEmpty(Token) && UserID.HasValue)
                {
                    Console.WriteLine("[LoginCallback] Saving session...");
                    await BuildAuth.SaveSessionAsync(Token, UserID.Value);
                    Console.WriteLine("[LoginCallback] Session saved. Navigating to profile...");
                    Navigation.NavigateTo("/profile");
                }
                else
                {
                    Console.WriteLine("[LoginCallback] Missing Token or UserID. redirecting home.");
                    Navigation.NavigateTo("/");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[LoginCallback] Error: {ex}");
                ErrorMessage = ex.Message + " | Stack: " + ex.StackTrace;
                logger.LogError(ex, "Login failed");
                StateHasChanged();
            }
        }
    }

    private string? ErrorMessage;
}

